{% extends "Base.j2" %}

{% block title %}{{ recipe.title }} — Grocery Guru{% endblock %}

{% block content %}
	<div class="card">
		<p style="margin: 0 0 1rem 0;">
			<a href="{{ url_for('recipes_index') }}">← Recipes</a>
			{% if recipe.category %}
				| <a href="{{ url_for('recipes_by_category', category=recipe.category) }}">{{ recipe.category }}</a>
			{% else %}
				| <a href="{{ url_for('recipes_by_category', category='Others') }}">Others</a>
			{% endif %}
		</p>
		<h1 id="recipe-title-display">{{ recipe.title }}</h1>
		<div id="recipe-view-actions" style="margin-bottom: 1rem;">
			<button type="button" id="btn-edit-recipe" class="btn btn-primary">Edit</button>
		</div>

		<div id="recipe-view" class="recipe-profile-view">
			<p class="recipe-source">
				<strong>Source:</strong>
				{% if recipe.source_url %}
					<a href="{{ recipe.source_url }}" target="_blank" rel="noopener noreferrer">{{ recipe.source_url }}</a>
				{% else %}
					<span class="text-muted">(none)</span>
				{% endif %}
			</p>
			<div class="recipe-section">
				<h3>Ingredients</h3>
				<ul class="recipe-checklist" id="recipe-ingredients-list">
					{% for line in ingredients_list %}
					<li class="recipe-check-item">
						<label class="recipe-check-label">
							<input type="checkbox" class="recipe-checkbox" data-type="ingredients" data-index="{{ loop.index0 }}">
							<span class="recipe-check-text">{{ line }}</span>
						</label>
					</li>
					{% else %}
					<li class="recipe-check-empty"><span class="text-muted">(none)</span></li>
					{% endfor %}
				</ul>
			</div>
			<div class="recipe-section">
				<h3>Steps</h3>
				<ul class="recipe-checklist" id="recipe-steps-list">
					{% for line in steps_list %}
					<li class="recipe-check-item">
						<label class="recipe-check-label">
							<input type="checkbox" class="recipe-checkbox" data-type="steps" data-index="{{ loop.index0 }}">
							<span class="recipe-check-text">{{ line }}</span>
						</label>
					</li>
					{% else %}
					<li class="recipe-check-empty"><span class="text-muted">(none)</span></li>
					{% endfor %}
				</ul>
			</div>
			<div class="recipe-section">
				<h3>Notes</h3>
				<pre class="recipe-block">{{ recipe.special_notes or '(none)' }}</pre>
			</div>
		</div>

		<form id="recipe-edit-form" method="post" action="{{ url_for('recipe_detail', recipe_id=recipe.id) }}" class="recipe-form" style="display: none;">
			<input type="hidden" name="action" value="update">
			<div class="form-group">
				<label for="title">Title</label>
				<input type="text" id="title" name="title" value="{{ recipe.title }}" required>
			</div>
			<div class="form-group">
				<label for="source_url">Original link <span class="text-muted">(optional)</span></label>
				<input type="url" id="source_url" name="source_url" value="{{ recipe.source_url or '' }}" placeholder="https://...">
			</div>
			<div class="form-group">
				<label for="category">Category <span class="text-muted">(optional, leave empty for Others)</span></label>
				<select id="category" name="category">
					<option value="">Others</option>
					{% for cat in categories %}
						<option value="{{ cat }}" {% if recipe.category == cat %}selected{% endif %}>{{ cat }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="form-group">
				<label for="ingredients">Ingredients</label>
				<textarea id="ingredients" name="ingredients" rows="8">{{ recipe.ingredients or '' }}</textarea>
			</div>
			<div class="form-group">
				<label for="steps">Steps</label>
				<textarea id="steps" name="steps" rows="10">{{ recipe.steps or '' }}</textarea>
			</div>
			<div class="form-group">
				<label for="special_notes">Special notes <span class="text-muted">(optional)</span></label>
				<textarea id="special_notes" name="special_notes" rows="3">{{ recipe.special_notes or '' }}</textarea>
			</div>
			<div class="form-actions">
				<button type="submit" class="btn btn-primary">Save changes</button>
				<button type="button" id="btn-cancel-edit" class="btn btn-secondary">Cancel</button>
			</div>
		</form>

		<div class="recipe-meta" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
			<form method="post" action="{{ url_for('recipe_detail', recipe_id=recipe.id) }}" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this recipe?');">
				<input type="hidden" name="action" value="delete">
				<button type="submit" class="btn btn-danger" aria-label="Delete recipe">
					<svg class="trash-icon" viewBox="0 0 24 24" width="20" height="20">
						<path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
					</svg>
					Delete recipe
				</button>
			</form>
		</div>
	</div>
	<script>
	(function() {
		var recipeId = {{ recipe.id }};
		var storageKey = function(type) { return 'recipe-' + recipeId + '-' + type; };

		var view = document.getElementById('recipe-view');
		var form = document.getElementById('recipe-edit-form');
		var viewActions = document.getElementById('recipe-view-actions');
		var btnEdit = document.getElementById('btn-edit-recipe');
		var btnCancel = document.getElementById('btn-cancel-edit');
		if (!view || !form) return;
		btnEdit.addEventListener('click', function() {
			view.style.display = 'none';
			form.style.display = 'block';
			viewActions.style.display = 'none';
		});
		btnCancel.addEventListener('click', function() {
			view.style.display = 'block';
			form.style.display = 'none';
			viewActions.style.display = 'block';
		});

		// Restore checkbox state from localStorage
		function loadChecks(type) {
			try {
				var raw = localStorage.getItem(storageKey(type));
				if (raw) {
					var idx = JSON.parse(raw);
					document.querySelectorAll('.recipe-checkbox[data-type="' + type + '"]').forEach(function(cb) {
						cb.checked = idx.indexOf(parseInt(cb.dataset.index, 10)) >= 0;
					});
				}
			} catch (e) {}
		}
		loadChecks('ingredients');
		loadChecks('steps');

		// Save checkbox state to localStorage
		document.querySelectorAll('.recipe-checkbox').forEach(function(cb) {
			cb.addEventListener('change', function() {
				var type = this.dataset.type;
				var checked = [];
				document.querySelectorAll('.recipe-checkbox[data-type="' + type + '"]').forEach(function(c) {
					if (c.checked) checked.push(parseInt(c.dataset.index, 10));
				});
				try { localStorage.setItem(storageKey(type), JSON.stringify(checked)); } catch (e) {}
			});
		});
	})();
	</script>
{% endblock %}
